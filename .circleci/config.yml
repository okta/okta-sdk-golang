# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  platform-orb: okta/general-platform-helpers@1.9
  platform-helpers: okta/platform-helpers@dev:alpha
  python: circleci/python@2.0.3
  aws-cli: circleci/aws-cli@5.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  test-v4:
    docker:
      - image: cimg/go:1.19.4
    steps:
      - checkout
      - run: go version
      - platform-orb/step-load-dependencies
      - run:
          name: "test stage"
          command: make test

  build-binaries:
    docker:
      - image: cimg/go:1.21.13
    steps:
      - checkout
      - run:
          name: Build binary to scan
          command: |
            go mod vendor
            go install ./...
      - attach_workspace:
          at: .

  reversinglabs-scan:
    docker:
        - image: cimg/python:3.10
    steps:
      - run:
          name: Set env vars
          command: |
            echo "export ARTIFACT_DIR=$(echo "${CIRCLE_WORKING_DIRECTORY/#\~/$HOME}")" >> "$BASH_ENV"
            echo "export ARTIFACT_COMMIT=$(echo "${CIRCLE_SHA1}")" >> "$BASH_ENV"
            echo "export ARTIFACT_NAME=$(echo "${CIRCLE_PROJECT_REPONAME}")" >> "$BASH_ENV"
            echo "export ARTIFACT_REPOSITORY=$(echo "${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}")" >> "$BASH_ENV"
            echo "export DSO_RLSECURE_TOKEN=$(echo "${DSO_RLSECURE_TOKEN}")" >> "$BASH_ENV"
            echo "export AWS_ARN=$(echo "${AWS_ARN}")" >> "$BASH_ENV"
            source "$BASH_ENV"
      - attach_workspace:
          at: .
      - platform-helpers/step-reversinglabs-scan:
            artifact-dir: ${ARTIFACT_DIR}
            artifact-name: ${ARTIFACT_NAME}
            artifact-version: $ARTIFACT_COMMIT
            artifact-repository: $ARTIFACT_REPOSITORY
            artifact-commit: $ARTIFACT_COMMIT
            dso-rlsecure-token: $DSO_RLSECURE_TOKEN
            aws-arn: $AWS_ARN

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  "Circle CI Tests":
    jobs:
      - test-v4
  # See OKTA-624790
  # See OKTA-729389
  semgrep:
    jobs:
      - platform-orb/job-semgrep-scan:
          name: "Scan with Semgrep"
          resource-class: "medium"
          context:
            - static-analysis
  "Malware Scanner":
    jobs:
      - build-binaries
      - reversinglabs-scan:
          context:
            - static-analysis
          requires: [ build-binaries ] #

# VS Code Extension Version: 1.4.0

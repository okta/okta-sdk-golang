# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  platform-orb: okta/general-platform-helpers@1.9
  platform-helpers: okta/platform-helpers@dev:alpha
  python: circleci/python@2.0.3
  aws-cli: circleci/aws-cli@5.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  test-v4:
    docker:
      - image: cimg/go:1.19.4
    steps:
      - checkout
      - run: go version
      - platform-orb/step-load-dependencies
      - run:
          name: "test stage"
          command: make test

  build-binaries:
    docker:
      - image: cimg/go:1.21.13
    steps:
      - checkout
      - run:
          name: Build binary to scan
          command: |
            go mod vendor
            go install ./...
      - run:
          name: Install Python
          command: |
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip
            sudo pip install --upgrade pip
      - run:
          name: Download and install ReversingLabs Wrapper
#          environment:
#            DSO_RLSECURE_TOKEN: "<<parameters.dso-rlsecure-token>>"
          command: |
            curl https://dso-resources.oktasecurity.com/scanner \
              -H "x-api-key: somebadapikeytoken" \
              --output rl_wrapper-0.0.2+35ababa-py3-none-any.whl
            echo "-----------------------------------------------------------------"
            pwd
            echo "-----------------------------------------------------------------"
            ls
            echo "-----------------------------------------------------------------"
            pip install ./rl_wrapper-0.0.2+35ababa-py3-none-any.whl
      - attach_workspace:
          at: .
# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  "Circle CI Tests":
    jobs:
      - test-v4
  # See OKTA-624790
  # See OKTA-729389
  semgrep:
    jobs:
      - platform-orb/job-semgrep-scan:
          name: "Scan with Semgrep"
          resource-class: "medium"
          context:
            - static-analysis
  "Malware Scanner":
    jobs:
      - build-binaries
      - platform-helpers/job-reversinglabs-scan:
          artifact-dir: ${CIRCLE_WORKING_DIRECTORY/#\~/$HOME}
          artifact-name: $CIRCLE_PROJECT_REPONAME
          artifact-version: $CIRCLE_SHA1
          artifact-repository: $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
          artifact-commit: $CIRCLE_SHA1
          dso-rlsecure-token: $DSO_RLSECURE_TOKEN
          aws-arn: $AWS_ARN
          context:
            - static-analysis
#          requires: [ build-binaries ]

# VS Code Extension Version: 1.4.0
